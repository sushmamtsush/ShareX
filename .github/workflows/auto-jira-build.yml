name: Create Jira Bug from GitHub

on:
  push:
    branches:
      - "**"

jobs:
  jira-bug:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Jira Bug
        id: create_jira
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

          BUILD_VERSION: "1.3.0"
          BUILD_CONFIG: "Release"
          LAST_WORKING_BUILD: "1.2.9"
          REGRESSION: "Yes"
        run: |
          SUMMARY="${{ github.event.head_commit.message }}"
          COMMIT="${{ github.sha }}"

          jq -n \
            --arg summary "$SUMMARY" \
            --arg commit "$COMMIT" \
            --arg buildVersion "$BUILD_VERSION" \
            --arg buildConfig "$BUILD_CONFIG" \
            --arg lastBuild "$LAST_WORKING_BUILD" \
            --arg regression "$REGRESSION" \
            '{
              fields: {
                project: { key: "SHAR" },
                issuetype: { name: "Bug" },
                summary: $summary,
                priority: { name: "High" },

                description: ("Automatically created from GitHub CI\nCommit: " + $commit),

                customfield_10247: $buildVersion,
                customfield_10248: { value: $buildConfig },
                customfield_10249: { value: $regression },
                customfield_10251: $lastBuild,

                customfield_10290: "Expected behavior from CI execution",
                customfield_10286: "Failure observed during automated build"
              }
            }' > payload.json

          RESPONSE=$(curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            "$JIRA_BASE_URL/rest/api/3/issue" \
            --data @payload.json)

          ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key')

          echo "Jira Issue Created: $ISSUE_KEY"
          echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT

      - name: Attach Logs
        if: always()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ steps.create_jira.outputs.issue_key }}
        run: |
          echo "Sample log content" > build.log

          curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
            -H "X-Atlassian-Token: no-check" \
            -F "file=@build.log" \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/attachments"

      - name: Add Jira Comment
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          ISSUE_KEY: ${{ steps.create_jira.outputs.issue_key }}
        run: |
          jq -n \
            --arg text "Build and logs attached automatically from GitHub Actions." \
            '{
              body: {
                type: "doc",
                version: 1,
                content: [
                  {
                    type: "paragraph",
                    content: [{ type: "text", text: $text }]
                  }
                ]
              }
            }' > comment.json

          curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/comment" \
            --data @comment.json
