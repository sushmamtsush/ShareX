name: Advanced Jira Bug Creator

on:
  issues:
    types: [opened]
  push:

jobs:
  create-jira-bug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set Jira environment variables
        run: |
          echo "JIRA_BASE_URL=${{ secrets.JIRA_BASE_URL }}" >> $GITHUB_ENV
          echo "JIRA_USER_EMAIL=${{ secrets.JIRA_USER_EMAIL }}" >> $GITHUB_ENV
          echo "JIRA_API_TOKEN=${{ secrets.JIRA_API_TOKEN }}" >> $GITHUB_ENV
          echo "JIRA_PROJECT_KEY=${{ secrets.JIRA_PROJECT_KEY }}" >> $GITHUB_ENV
          echo "GITHUB_REPO_URL=https://github.com/${{ github.repository }}" >> $GITHUB_ENV

      - name: Parse GitHub Issue and Create Jira Bug
        shell: bash
        run: |
          ISSUE_BODY=$(jq -r '.issue.body // ""' $GITHUB_EVENT_PATH)

          # --- SMART FIELD DETECTION ---
          SUMMARY=$(echo "$ISSUE_BODY" | head -n1)
          PRIORITY=$(echo "$ISSUE_BODY" | grep -i "priority:" | head -n1 | cut -d':' -f2 | xargs)
          ASSIGNEE=$(echo "$ISSUE_BODY" | grep -i "assignee:" | head -n1 | cut -d':' -f2 | xargs)
          REPORTER=$(echo "$ISSUE_BODY" | grep -i "reporter:" | head -n1 | cut -d':' -f2 | xargs)
          COMPONENTS=$(echo "$ISSUE_BODY" | grep -i "components:" | head -n1 | cut -d':' -f2 | tr ',' '\n' | awk '{$1=$1; print}')

          # --- Auto-detect description sections ---
          EXPECTED_BEHAVIOR=$(echo "$ISSUE_BODY" | sed -n '/expected behavior:/I, /actual behavior:/I{ /expected behavior:/I!p }' | xargs)
          ACTUAL_BEHAVIOR=$(echo "$ISSUE_BODY" | sed -n '/actual behavior:/I, /steps:/I{ /actual behavior:/I!p }' | xargs)
          TEST_STEPS=$(echo "$ISSUE_BODY" | sed -n '/steps:/I, /environment:/I{ /steps:/I!p }' | xargs)
          ENVIRONMENT=$(echo "$ISSUE_BODY" | sed -n '/environment:/I, /attachments:/I{ /environment:/I!p }' | xargs)

          # --- Attachments ---
          ATTACHMENTS=$(echo "$ISSUE_BODY" | grep -oP '(?<=\]\().*?(?=\))')

          # --- Priority mapping ---
          case "${PRIORITY,,}" in
            highest) PRIORITY_ID="1" ;;
            high)    PRIORITY_ID="2" ;;
            medium)  PRIORITY_ID="3" ;;
            low)     PRIORITY_ID="4" ;;
            lowest)  PRIORITY_ID="5" ;;
            *)       PRIORITY_ID="3" ;;
          esac

          # --- Jira payload ---
          payload=$(jq -n \
            --arg project "$JIRA_PROJECT_KEY" \
            --arg summary "$SUMMARY" \
            --arg description "$TEST_STEPS" \
            --arg expectedBehavior "$EXPECTED_BEHAVIOR" \
            --arg actualBehavior "$ACTUAL_BEHAVIOR" \
            --arg environment "$ENVIRONMENT" \
            --argjson components "$(jq -n '$ARGS.positional | map({name: .})' --args $COMPONENTS)" \
            --arg priority_id "$PRIORITY_ID" \
            --arg assignee "$ASSIGNEE" \
            --arg reporter "$REPORTER" \
            '{
              fields: {
                project: { key: $project },
                summary: $summary,
                description: $description,
                issuetype: { name: "Bug" },
                components: $components,
                priority: { id: $priority_id },
                assignee: { name: $assignee },
                reporter: { name: $reporter },
                labels: ["github", "auto-created"],
                customfield_10290: $expectedBehavior,
                customfield_10286: $actualBehavior,
                environment: $environment
              }
            }')

          # --- Create Jira Issue ---
          response=$(curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
            -X POST \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/3/issue" \
            --data "$payload")

          ISSUE_KEY=$(echo "$response" | jq -r '.key')
          echo "Created Jira Issue: $ISSUE_KEY"

          # --- Upload attachments ---
          mkdir -p /tmp/github_attachments
          for url in $ATTACHMENTS; do
            filename=$(basename "$url")
            wget -q "$url" -O "/tmp/github_attachments/$filename"
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X POST \
              -H "X-Atlassian-Token: no-check" \
              -F "file=@/tmp/github_attachments/$filename" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/attachments"
          done

          echo "Jira issue $ISSUE_KEY updated with attachments and structured fields."
