- name: Create Jira Issue via API
  env:
    JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
    JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
    JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
    JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
    COMMIT_MSG: ${{ github.event.head_commit.message }}
    REPO: ${{ github.repository }}
    SHA: ${{ github.sha }}
  run: |
    echo "Creating Jira issue..."

    jq -n \
      --arg project "$JIRA_PROJECT_KEY" \
      --arg summary "$COMMIT_MSG" \
      --arg repo "$REPO" \
      --arg sha "$SHA" \
      '{
        fields: {
          project: { key: $project },
          summary: $summary,
          description: {
            type: "doc",
            version: 1,
            content: [
              {
                type: "paragraph",
                content: [{ type: "text", text: "Automatically created from GitHub push." }]
              },
              {
                type: "paragraph",
                content: [
                  { type: "text", text: "Repository: " },
                  { type: "text", text: $repo, marks: [{ type: "strong" }] }
                ]
              },
              {
                type: "paragraph",
                content: [
                  { type: "text", text: "Commit: " },
                  { type: "text", text: $sha }
                ]
              }
            ]
          },
          issuetype: { name: "Task" },
          labels: ["github", "auto-created"]
        }
      }' > payload.json

    curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
      -H "Content-Type: application/json" \
      -X POST \
      "$JIRA_BASE_URL/rest/api/3/issue" \
      --data @payload.json
